#!/usr/bin/env nu

#MISE description="Prepare after `mise install`. Build intermediate files and initialize local DBs."

use ../_libs *

const tasksDirPath = path self | path dirname | path join ".."
const projectRootPath = $tasksDirPath | path join "../.." | path expand

if not ("SERVER_ENV" in $env) {
  print "[ERROR] The environment variable SERVER_ENV is missing. If you are on your local machine, copy mise.local.example.toml to mise.local.toml, or set `SERVER_ENV=development` manually."
  exit 1
}

# Generate DB Schemas: Currency codes
mise prepare:currencies

# Generate DB Schemas: BetterAuth
## Requires to properly load auth.ts which imports the generated BetterAuth schema.
cp ($tasksDirPath | path join "_fixtures/barrel-dummy.ts") ($projectRootPath | path join "src/lib/db/schema/index.ts")
pnpx @better-auth/cli generate --yes --output="./src/lib/db/schema/better-auth.ts" # relative path from project root

# Generate barrel file for schemas
mise prepare:barrel

if ($env.SERVER_ENV == "development") {
  container compose up -d --wait
} else if ($env.SERVER_ENV == "demo-preview") {
  pnpm neon branches reset $"preview/($env.VERCEL_GIT_COMMIT_REF)" --parent --project-id=($env.NEON_PROJECT_ID)
}

pnpm drizzle-kit generate
pnpm drizzle-kit migrate
